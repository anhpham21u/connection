{% extends "components/base.html" %}
{% load static %}

{% block title %}{{post.title}}{% endblock title %}

{% block extrastyles %}
<link rel="stylesheet" type="text/css" href="{% static 'css/app.css' %}" />
{% endblock extrastyles %}

{% block content %}
<div class="border-bottom">
  <h2>{{ post.title }}</h2>
  <div class="d-flex gap-4">
    <p>
      <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
          <circle cx="12" cy="6" r="4" stroke="#1C274C" stroke-width="1.5"></circle>
          <path
            d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"
            stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path>
        </g>
      </svg>
      {{ post.user.username }}
      </span>
    </p>

    <div>
      <a class="text-decoration-none" href="{% url "like_post" post.id %}">
        {% if request.user in post.likes.all %}
        <svg version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
          width="25px" height="25px" viewBox="0 0 64 64" enable-background="new 0 0 64 64" xml:space="preserve"
          fill="#000000">
          <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
          <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
          <g id="SVGRepo_iconCarrier">
            <path fill="#df3434"
              d="M48,5c-4.418,0-8.418,1.791-11.313,4.687l-3.979,3.961c-0.391,0.391-1.023,0.391-1.414,0 c0,0-3.971-3.97-3.979-3.961C24.418,6.791,20.418,5,16,5C7.163,5,0,12.163,0,21c0,3.338,1.024,6.436,2.773,9 c0,0,0.734,1.164,1.602,2.031s24.797,24.797,24.797,24.797C29.953,57.609,30.977,58,32,58s2.047-0.391,2.828-1.172 c0,0,23.93-23.93,24.797-24.797S61.227,30,61.227,30C62.976,27.436,64,24.338,64,21C64,12.163,56.837,5,48,5z M57,22 c-0.553,0-1-0.447-1-1c0-4.418-3.582-8-8-8c-0.553,0-1-0.447-1-1s0.447-1,1-1c5.522,0,10,4.478,10,10C58,21.553,57.553,22,57,22z">
            </path>
          </g>
        </svg>
        {% else %}
        <svg version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
          width="25px" height="25px" viewBox="0 0 64 64" enable-background="new 0 0 64 64" xml:space="preserve"
          fill="#000000">
          <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
          <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
          <g id="SVGRepo_iconCarrier">
            <path fill="#8b8797"
              d="M48,5c-4.418,0-8.418,1.791-11.313,4.687l-3.979,3.961c-0.391,0.391-1.023,0.391-1.414,0 c0,0-3.971-3.97-3.979-3.961C24.418,6.791,20.418,5,16,5C7.163,5,0,12.163,0,21c0,3.338,1.024,6.436,2.773,9 c0,0,0.734,1.164,1.602,2.031s24.797,24.797,24.797,24.797C29.953,57.609,30.977,58,32,58s2.047-0.391,2.828-1.172 c0,0,23.93-23.93,24.797-24.797S61.227,30,61.227,30C62.976,27.436,64,24.338,64,21C64,12.163,56.837,5,48,5z M57,22 c-0.553,0-1-0.447-1-1c0-4.418-3.582-8-8-8c-0.553,0-1-0.447-1-1s0.447-1,1-1c5.522,0,10,4.478,10,10C58,21.553,57.553,22,57,22z">
            </path>
          </g>
        </svg>
        {% endif %}
      </a>
      <span id="like-count">{{ post.likes.count }} likes</span>
    </div>

    <div>
      <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
          <path
            d="M5 22V14M5 14V4M5 14L7.47067 13.5059C9.1212 13.1758 10.8321 13.3328 12.3949 13.958C14.0885 14.6354 15.9524 14.7619 17.722 14.3195L17.8221 14.2945C18.4082 14.148 18.6861 13.4769 18.3753 12.9589L16.8147 10.3578C16.4732 9.78863 16.3024 9.50405 16.2619 9.19451C16.2451 9.06539 16.2451 8.93461 16.2619 8.80549C16.3024 8.49595 16.4732 8.21137 16.8147 7.64221L18.0932 5.51132C18.4278 4.9536 17.9211 4.26972 17.2901 4.42746C15.8013 4.79967 14.2331 4.69323 12.8082 4.12329L12.3949 3.95797C10.8321 3.33284 9.1212 3.17576 7.47067 3.50587L5 4M5 4V2"
            stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path>
        </g>
      </svg>
      {{post.topic}}
    </div>

    <p>{{ time_ago }}</p>
  </div>
</div>
<div class="mt-4 mb-4">
  <p>{{ post.content|safe }}</p>
</div>
<div>
  <div class="mb-1 border-top">
    <div class="d-flex align-items-center">
      <svg width="20px" height="20px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns"
        fill="#000000">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
          <title>comment-2</title>
          <desc>Created with Sketch Beta.</desc>
          <defs> </defs>
          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
            <g id="Icon-Set" sketch:type="MSLayerGroup" transform="translate(-152.000000, -255.000000)" fill="#000000">
              <path
                d="M168,281 C166.832,281 165.704,280.864 164.62,280.633 L159.912,283.463 L159.975,278.824 C156.366,276.654 154,273.066 154,269 C154,262.373 160.268,257 168,257 C175.732,257 182,262.373 182,269 C182,275.628 175.732,281 168,281 L168,281 Z M168,255 C159.164,255 152,261.269 152,269 C152,273.419 154.345,277.354 158,279.919 L158,287 L165.009,282.747 C165.979,282.907 166.977,283 168,283 C176.836,283 184,276.732 184,269 C184,261.269 176.836,255 168,255 L168,255 Z M175,266 L161,266 C160.448,266 160,266.448 160,267 C160,267.553 160.448,268 161,268 L175,268 C175.552,268 176,267.553 176,267 C176,266.448 175.552,266 175,266 L175,266 Z M173,272 L163,272 C162.448,272 162,272.447 162,273 C162,273.553 162.448,274 163,274 L173,274 C173.552,274 174,273.553 174,273 C174,272.447 173.552,272 173,272 L173,272 Z"
                id="comment-2" sketch:type="MSShapeGroup"> </path>
            </g>
          </g>
        </g>
      </svg>
      <p class="m-1" id="comment-cnt">{{ comment_count }} comments</p>
    </div>
    <form class="d-flex align-items-center mb-3">
      <div class="pe-1 flex-grow-1">
        {% if user.is_authenticated %}
        <textarea class="w-100 comment-input form-control" id="comment" data-post-id="{{post.id}}" name="comment"
          placeholder="Type your comment" required></textarea>
        {% else %}
        <textarea class="w-100 comment-input form-control" id="comment" data-post-id="{{post.id}}" name="comment"
          placeholder="Log in to comment" required disabled></textarea>
        {% endif %}
      </div>
      {% if user.is_authenticated %}
      <button class="btn btn-outline-success" type="button" id="submit_comment">Gửi</button>
      {% else %}
      <button class="btn btn-outline-success" type="button" id="submit_comment" disabled>Gửi</button>
      {% endif %}
    </form>
  </div>

  <div id="list-comment">
    {% for comment in comments %}
    <div class="mb-2">
      <div class="rounded d-inline-block p-1 px-2 comment-card">
        <p class="m-0 comment-user-card">{{ comment.user }}</p>
        <p class="m-0">{{ comment }}</p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  const submitComment = document.getElementById('submit_comment')
  const textComment = document.getElementById('comment')
  const listComment = document.getElementById('list-comment')
  const commentCnt = document.getElementById('comment-cnt')
  submitComment.addEventListener('click', () => {
    const csrfToken = "{{ csrf_token }}";
    const id = textComment.getAttribute('data-post-id');

    fetch(`/post/${id}/comment/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          textComment: textComment.value
        })
      }).then((response) => response.json())
      .then((data) => {
        // console.log(data);
        const user = "{{ user.username }}"
        const commentEl = document.createElement("div");
        commentEl.classList.add("mb-2");
        commentEl.innerHTML = `
        <div class="rounded d-inline-block p-1 px-2 comment-card">
          <p class="m-0 comment-user-card">${user}</p>
          <p class="m-0">${textComment.value}</p>
        </div>
        `;
        listComment.appendChild(commentEl);

        commentCnt.textContent = parseInt(commentCnt.textContent) + 1
        commentCnt.textContent += ' comments'

        textComment.value = "";
      });
  })
</script>
{% endblock content %}